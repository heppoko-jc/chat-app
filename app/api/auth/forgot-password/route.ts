// app/api/auth/forgot-password/route.ts

import { NextRequest, NextResponse } from "next/server";
import { PrismaClient } from "@prisma/client";
import crypto from "crypto";
import { Resend } from "resend";

const prisma = new PrismaClient();

// Resendã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å®‰å…¨ã«ä½œæˆï¼ˆç’°å¢ƒå¤‰æ•°ãŒãªã„å ´åˆã¯nullï¼‰
let resendInstance: Resend | null = null;
if (process.env.RESEND_API_KEY) {
  resendInstance = new Resend(process.env.RESEND_API_KEY);
}

export async function POST(req: NextRequest) {
  try {
    const { email } = await req.json();

    console.log("ğŸ”¹ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ:", { email });

    if (!email) {
      return NextResponse.json(
        { error: "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå¿…è¦ã§ã™" },
        { status: 400 }
      );
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢
    const user = await prisma.user.findUnique({ where: { email } });

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã—ãªã„å ´åˆã§ã‚‚åŒã˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã™
    if (user) {
      // ãƒªã‚»ãƒƒãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆ
      const resetToken = crypto.randomBytes(32).toString("hex");
      const resetExpires = new Date();
      resetExpires.setHours(resetExpires.getHours() + 1); // 1æ™‚é–“æœ‰åŠ¹

      // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
      await prisma.user.update({
        where: { id: user.id },
        data: {
          passwordResetToken: resetToken,
          passwordResetExpires: resetExpires,
        },
      });

      console.log("âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆ:", {
        email: user.email,
        token: resetToken.substring(0, 10) + "...",
      });

      // ã‚¢ãƒ—ãƒªã®URLã‚’å–å¾—ï¼ˆæ—¢å­˜ã‚³ãƒ¼ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³ã«åˆã‚ã›ã‚‹ï¼‰
      const appUrl =
        process.env.NEXT_PUBLIC_APP_URL || "http://localhost:3000";
      const resetUrl = `${appUrl}/reset-password?token=${resetToken}`;

      // ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚’è©¦ã¿ã‚‹
      let emailSent = false;
      if (resendInstance && process.env.RESEND_API_KEY) {
        try {
          const fromEmail =
            process.env.RESEND_FROM_EMAIL || "onboarding@resend.dev";

          await resendInstance.emails.send({
            from: fromEmail,
            to: user.email,
            subject: "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã®ãŠçŸ¥ã‚‰ã›",
            html: `
              <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                <h2 style="color: #333;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ</h2>
                <p>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚</p>
                <p>ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼š</p>
                <p style="margin: 20px 0;">
                  <a href="${resetUrl}" style="background-color: #0070f3; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;">
                    ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
                  </a>
                </p>
                <p style="color: #666; font-size: 14px;">
                  ã“ã®ãƒªãƒ³ã‚¯ã¯1æ™‚é–“æœ‰åŠ¹ã§ã™ã€‚<br>
                  ã‚‚ã—ã“ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã—ã¦ã„ãªã„å ´åˆã¯ã€ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚’ç„¡è¦–ã—ã¦ãã ã•ã„ã€‚
                </p>
                <p style="color: #666; font-size: 12px; margin-top: 30px;">
                  ãƒªãƒ³ã‚¯ãŒã‚¯ãƒªãƒƒã‚¯ã§ããªã„å ´åˆã¯ã€ä»¥ä¸‹ã®URLã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã«ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆã—ã¦ãã ã•ã„ï¼š<br>
                  ${resetUrl}
                </p>
              </div>
            `,
            text: `ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ\n\nä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼š\n\n${resetUrl}\n\nã“ã®ãƒªãƒ³ã‚¯ã¯1æ™‚é–“æœ‰åŠ¹ã§ã™ã€‚`,
          });

          emailSent = true;
          console.log("âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ:", user.email);
        } catch (emailError: any) {
          console.error("ğŸš¨ ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒ©ãƒ¼:", {
            error: emailError?.message || emailError,
            email: user.email,
            resendError: emailError?.response?.data || emailError?.response,
          });
          // ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã«å¤±æ•—ã—ã¦ã‚‚å‡¦ç†ã¯ç¶šè¡Œï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ï¼‰
        }
      }

      // é–‹ç™ºç’°å¢ƒã¾ãŸã¯ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã«å¤±æ•—ã—ãŸå ´åˆã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
      if (!emailSent || process.env.NODE_ENV === "development") {
        console.log("ğŸ“§ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒªãƒ³ã‚¯:", resetUrl);
        if (!emailSent) {
          console.warn(
            "âš ï¸ ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸã€‚RESEND_API_KEYãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ã‹ã€ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
          );
        }
      }
    }

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€å¸¸ã«æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã™
    return NextResponse.json({
      message: "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆç”¨ã®ãƒªãƒ³ã‚¯ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«ã‚’ã”ç¢ºèªãã ã•ã„ã€‚",
    });
  } catch (error) {
    console.error("ğŸš¨ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:", error);
    return NextResponse.json(
      { error: "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ" },
      { status: 500 }
    );
  }
}
