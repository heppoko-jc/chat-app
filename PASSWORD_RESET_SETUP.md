# パスワード再設定機能のセットアップガイド

## 📋 概要

このガイドでは、パスワード再設定機能で使用するResendメール送信サービスのセットアップ方法を説明します。

---

## 🚀 クイックスタート

### 1. Resendアカウントの作成

1. **Resendにアクセス**
   - https://resend.com にアクセス
   - 「Sign Up」をクリックしてアカウントを作成（無料プランで開始可能）

2. **APIキーの取得**
   - ログイン後、左側メニューから「API Keys」を選択
   - 「Create API Key」をクリック
   - キー名を入力（例: `chat-app-production`）
   - 必要な権限を選択（通常はデフォルトで問題ありません）
   - 「Add」をクリック
   - **重要**: APIキーは一度しか表示されないため、すぐにコピーして安全な場所に保存してください
   - APIキーの形式: `re_xxxxxxxxxxxxx`

### 2. 送信元メールアドレスの設定

#### 開発環境（テスト用）

Resendにはテスト用の送信元アドレスが用意されています：
- `onboarding@resend.dev` - テスト用（検証不要）

このアドレスは、Resendアカウントに登録したメールアドレスにのみ送信できます。

#### 本番環境（推奨）

独自ドメインを使用する場合：

1. **ドメインの追加**
   - Resendダッシュボード → 「Domains」を選択
   - 「Add Domain」をクリック
   - ドメイン名を入力（例: `yourdomain.com`）

2. **DNSレコードの設定**
   - Resendが提供するDNSレコードをドメインのDNS設定に追加
   - 通常、以下のレコードが追加されます：
     - SPFレコード
     - DKIMレコード
   - DNSの反映には数分〜数時間かかる場合があります

3. **ドメインの検証**
   - DNSレコードが正しく設定されると、Resendが自動で検証します
   - 検証が完了するまで待ちます（ステータスが「Verified」になる）

---

## 🔧 環境変数の設定

### ローカル開発環境（`.env.local`）

プロジェクトのルートディレクトリに `.env.local` ファイルを作成（または既存のファイルに追加）：

```bash
# Resend設定
RESEND_API_KEY=re_xxxxxxxxxxxxx
RESEND_FROM_EMAIL=onboarding@resend.dev

# アプリのURL（開発環境）
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

**注意**: 
- `RESEND_API_KEY` は実際のAPIキーに置き換えてください
- 開発環境では `onboarding@resend.dev` を使用できます
- `.env.local` ファイルは Git にコミットされません（安全のため）

### Vercel本番環境

1. **Vercel Dashboardにアクセス**
   - https://vercel.com/dashboard にログイン
   - プロジェクトを選択

2. **環境変数を追加**
   - 「Settings」→「Environment Variables」を選択
   - 以下の環境変数を追加：

   ```
   RESEND_API_KEY=re_xxxxxxxxxxxxx
   RESEND_FROM_EMAIL=noreply@yourdomain.com
   NEXT_PUBLIC_APP_URL=https://your-app.vercel.app
   ```

   - **Environment**: 
     - `Production`（本番環境用）
     - `Preview`（プレビュー環境用、必要に応じて）
     - `Development`（開発環境用、必要に応じて）

3. **保存**
   - 「Save」をクリック

4. **再デプロイ**
   - 環境変数を追加/変更した後は、再デプロイが必要です
   - 「Deployments」タブから最新のデプロイを選択
   - 「Redeploy」をクリック
   - または、コードを少し変更して Git にプッシュ（自動デプロイ）

---

## ✅ 動作確認

### 1. 開発環境での確認

1. **環境変数を設定**
   - `.env.local` ファイルに必要な環境変数を設定

2. **開発サーバーを起動**
   ```bash
   npm run dev
   ```

3. **テスト実行**
   - ブラウザで `http://localhost:3000/forgot-password` にアクセス
   - テスト用メールアドレス（Resendアカウントに登録したメールアドレス）を入力
   - 「リセットリンクを送信」をクリック

4. **メールの確認**
   - メールボックス（および迷惑メールフォルダ）を確認
   - メールが届いていることを確認
   - メール内のリンクをクリックして、パスワードリセットページに遷移することを確認

5. **コンソールログの確認**
   - 開発サーバーのコンソールで、以下のログが出力されることを確認：
     - `✅ パスワードリセットトークンを生成`
     - `✅ パスワードリセットメールを送信しました`
   - エラーが発生した場合は、ログを確認してください

### 2. 本番環境での確認

1. **環境変数の設定**
   - Vercel Dashboard で環境変数を設定

2. **デプロイ**
   - コードをデプロイ（環境変数変更後は再デプロイが必要）

3. **テスト実行**
   - 本番環境のURL（例: `https://your-app.vercel.app/forgot-password`）にアクセス
   - 実際のユーザーメールアドレスを入力
   - 「リセットリンクを送信」をクリック

4. **メールの確認**
   - メールボックス（および迷惑メールフォルダ）を確認
   - メールが届いていることを確認

---

## 🐛 トラブルシューティング

### メールが届かない場合

1. **環境変数の確認**
   - `RESEND_API_KEY` が正しく設定されているか確認
   - `.env.local` ファイルが正しい場所にあるか確認
   - Vercelの環境変数が正しく設定されているか確認

2. **開発サーバーの再起動**
   - 環境変数を変更した後は、開発サーバーを再起動してください
   ```bash
   # サーバーを停止（Ctrl + C）
   # サーバーを再起動
   npm run dev
   ```

3. **Resendアカウントの確認**
   - Resendダッシュボード → 「Emails」を確認
   - 送信履歴とステータスを確認
   - エラーメッセージがある場合は確認

4. **送信元メールアドレスの確認**
   - 開発環境: `onboarding@resend.dev` は登録済みメールアドレスにのみ送信可能
   - 本番環境: ドメインが正しく検証されているか確認

5. **ログの確認**
   - サーバーのコンソールログでエラーメッセージを確認
   - ブラウザの開発者ツール（F12）→ Console タブでエラーを確認

### よくあるエラー

#### `RESEND_API_KEY is not set`
- **原因**: 環境変数 `RESEND_API_KEY` が設定されていない
- **解決方法**: `.env.local` または Vercel の環境変数を設定

#### `Invalid API key`
- **原因**: APIキーが間違っている、または無効になっている
- **解決方法**: Resendダッシュボードで新しいAPIキーを生成

#### `Domain not verified`
- **原因**: 本番環境で使用しているドメインが検証されていない
- **解決方法**: Resendダッシュボードでドメインの検証ステータスを確認し、必要に応じてDNSレコードを設定

#### `Rate limit exceeded`
- **原因**: Resendの送信制限に達した
- **解決方法**: 
  - 無料プラン: 月間3,000通まで
  - 有料プランへのアップグレードを検討

---

## 📊 Resendの料金プラン

### 無料プラン
- 月間3,000通まで送信可能
- テスト用メールアドレス（`onboarding@resend.dev`）が使用可能
- 基本的な機能が利用可能

### 有料プラン
- 月間50,000通以上送信可能
- 独自ドメインの使用
- 詳細な分析機能
- 優先サポート

詳細: https://resend.com/pricing

---

## 📝 実装の詳細

### 実装されている機能

- ✅ パスワードリセットトークンの生成（32バイトのランダム文字列）
- ✅ トークンの有効期限管理（1時間）
- ✅ メール送信（Resend経由）
- ✅ エラーハンドリング（メール送信失敗時もセキュリティ上成功メッセージを返す）
- ✅ 開発環境でのフォールバック（コンソール出力）
- ✅ セキュリティ対策（ユーザーが存在しない場合でも同じメッセージを返す）

### セキュリティ考慮事項

1. **トークンの有効期限**: 1時間のみ有効
2. **トークンの一意性**: 32バイトのランダム文字列
3. **情報漏洩の防止**: ユーザーが存在しない場合でも同じメッセージを返す
4. **トークンの使用後削除**: パスワードリセット後にトークンは削除される

---

## 🔗 関連ドキュメント

- [環境変数の設定方法](./ENV_SETUP_GUIDE.md)
- [Vercel環境変数の設定方法](./VERCEL_ENV_SETUP_FOR_COLLABORATOR.md)
- [Resend公式ドキュメント](https://resend.com/docs)

---

## 💡 補足情報

### 開発環境でのテスト

開発環境では、メール送信に失敗してもコンソールにリンクが出力されるため、環境変数を設定しなくても動作確認は可能です。ただし、実際のメール送信機能をテストするには、環境変数の設定が必要です。

### 本番環境への移行

本番環境で使用する場合：
1. 独自ドメインの検証を完了
2. `RESEND_FROM_EMAIL` を独自ドメインに変更（例: `noreply@yourdomain.com`）
3. Vercelの環境変数を設定
4. 再デプロイ

---

最終更新日: 2025年1月

