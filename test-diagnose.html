<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>診断ページ</title>
    <style>
      body {
        font-family: monospace;
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
      }
      .loading {
        color: #888;
      }
      .error {
        color: #d32f2f;
        background: #ffebee;
        padding: 15px;
        border-radius: 5px;
      }
      .success {
        background: #e8f5e9;
        padding: 15px;
        border-radius: 5px;
        margin-top: 20px;
      }
      pre {
        background: #f5f5f5;
        padding: 15px;
        border-radius: 5px;
        overflow: auto;
        font-size: 12px;
      }
      h2 {
        margin-top: 30px;
      }
      ul {
        line-height: 1.8;
      }
    </style>
  </head>
  <body>
    <h1>🔍 プッシュ通知診断</h1>
    <div id="status" class="loading">診断中...</div>
    <div id="result"></div>

    <script>
      async function diagnose() {
        const statusDiv = document.getElementById("status");
        const resultDiv = document.getElementById("result");

        try {
          // プロジェクトURLに置き換えてください
          const baseUrl = "https://happy-ice-cream.vercel.app";
          const diagnoseUrl = `${baseUrl}/api/admin/diagnose`;

          statusDiv.textContent = "診断中: " + diagnoseUrl;

          const res = await fetch(diagnoseUrl);

          if (!res.ok) {
            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
          }

          const data = await res.json();

          statusDiv.textContent = "✅ 診断完了";
          statusDiv.className = "success";

          let html = `
                    <h2>📊 診断結果</h2>
                    <pre>${JSON.stringify(data, null, 2)}</pre>

                    <h2>✅ チェックポイント</h2>
                    <div class="success">
                        <ul>
                            <li>環境変数（VAPID）: ${
                              data.environment?.has_vapid_public &&
                              data.environment?.has_vapid_private
                                ? "✅ 設定済み"
                                : "❌ 未設定"
                            }</li>
                            <li>アクティブな購読数: ${
                              data.push_subscriptions?.total_active || 0
                            }</li>
                            <li>過去24時間のメッセージ数: ${
                              data.messages?.sent_messages_24h || 0
                            }</li>
                            <li>未マッチメッセージ数: ${
                              data.unmatched_messages?.unmatched_count || 0
                            }</li>
                            <li>フィード新着があるユーザー数: ${
                              data.feed_messages?.total_users_with_feed_new || 0
                            }</li>
                        </ul>
                    </div>

                    <h2>🚀 次のステップ</h2>
                    <p>ダイジェストAPIを実行:</p>
                    <pre>${baseUrl}/api/cron/digest-17</pre>
                `;

          resultDiv.innerHTML = html;
        } catch (error) {
          statusDiv.textContent = "❌ エラー発生";
          statusDiv.className = "error";
          resultDiv.innerHTML = `
                    <div class="error">
                        <h2>エラー詳細</h2>
                        <pre>${error.message}</pre>
                        <p><strong>考えられる原因:</strong></p>
                        <ul>
                            <li>デプロイがまだ完了していない</li>
                            <li>認証保護が有効になっている</li>
                            <li>URLが正しくない</li>
                        </ul>
                    </div>
                `;
        }
      }

      diagnose();
    </script>
  </body>
</html>
