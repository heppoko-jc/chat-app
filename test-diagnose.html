<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è¨ºæ–­ãƒšãƒ¼ã‚¸</title>
    <style>
      body {
        font-family: monospace;
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
      }
      .loading {
        color: #888;
      }
      .error {
        color: #d32f2f;
        background: #ffebee;
        padding: 15px;
        border-radius: 5px;
      }
      .success {
        background: #e8f5e9;
        padding: 15px;
        border-radius: 5px;
        margin-top: 20px;
      }
      pre {
        background: #f5f5f5;
        padding: 15px;
        border-radius: 5px;
        overflow: auto;
        font-size: 12px;
      }
      h2 {
        margin-top: 30px;
      }
      ul {
        line-height: 1.8;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ” ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥è¨ºæ–­</h1>
    <div id="status" class="loading">è¨ºæ–­ä¸­...</div>
    <div id="result"></div>

    <script>
      async function diagnose() {
        const statusDiv = document.getElementById("status");
        const resultDiv = document.getElementById("result");

        try {
          // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆURLã«ç½®ãæ›ãˆã¦ãã ã•ã„
          const baseUrl = "https://happy-ice-cream.vercel.app";
          const diagnoseUrl = `${baseUrl}/api/admin/diagnose`;

          statusDiv.textContent = "è¨ºæ–­ä¸­: " + diagnoseUrl;

          const res = await fetch(diagnoseUrl);

          if (!res.ok) {
            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
          }

          const data = await res.json();

          statusDiv.textContent = "âœ… è¨ºæ–­å®Œäº†";
          statusDiv.className = "success";

          let html = `
                    <h2>ğŸ“Š è¨ºæ–­çµæœ</h2>
                    <pre>${JSON.stringify(data, null, 2)}</pre>

                    <h2>âœ… ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ</h2>
                    <div class="success">
                        <ul>
                            <li>ç’°å¢ƒå¤‰æ•°ï¼ˆVAPIDï¼‰: ${
                              data.environment?.has_vapid_public &&
                              data.environment?.has_vapid_private
                                ? "âœ… è¨­å®šæ¸ˆã¿"
                                : "âŒ æœªè¨­å®š"
                            }</li>
                            <li>ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªè³¼èª­æ•°: ${
                              data.push_subscriptions?.total_active || 0
                            }</li>
                            <li>éå»24æ™‚é–“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°: ${
                              data.messages?.sent_messages_24h || 0
                            }</li>
                            <li>æœªãƒãƒƒãƒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°: ${
                              data.unmatched_messages?.unmatched_count || 0
                            }</li>
                            <li>ãƒ•ã‚£ãƒ¼ãƒ‰æ–°ç€ãŒã‚ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: ${
                              data.feed_messages?.total_users_with_feed_new || 0
                            }</li>
                        </ul>
                    </div>

                    <h2>ğŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—</h2>
                    <p>ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆAPIã‚’å®Ÿè¡Œ:</p>
                    <pre>${baseUrl}/api/cron/digest-17</pre>
                `;

          resultDiv.innerHTML = html;
        } catch (error) {
          statusDiv.textContent = "âŒ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ";
          statusDiv.className = "error";
          resultDiv.innerHTML = `
                    <div class="error">
                        <h2>ã‚¨ãƒ©ãƒ¼è©³ç´°</h2>
                        <pre>${error.message}</pre>
                        <p><strong>è€ƒãˆã‚‰ã‚Œã‚‹åŸå› :</strong></p>
                        <ul>
                            <li>ãƒ‡ãƒ—ãƒ­ã‚¤ãŒã¾ã å®Œäº†ã—ã¦ã„ãªã„</li>
                            <li>èªè¨¼ä¿è­·ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹</li>
                            <li>URLãŒæ­£ã—ããªã„</li>
                        </ul>
                    </div>
                `;
        }
      }

      diagnose();
    </script>
  </body>
</html>
